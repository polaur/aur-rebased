From e2971b363f38d77ee7df079b6f352a2ae5405854 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Thu, 23 Feb 2023 14:34:10 +0100
Subject: [PATCH] Revert "uaccess: Add speculation barrier to copy_from_user()"

This reverts commit 5a856cdc5eee5df033f2adc3fd9e696195fcd954.

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 include/linux/nospec.h | 4 ----
 kernel/bpf/core.c      | 2 ++
 lib/usercopy.c         | 7 -------
 3 files changed, 2 insertions(+), 11 deletions(-)

diff --git a/include/linux/nospec.h b/include/linux/nospec.h
index 9f0af4f11..c1e79f72c 100644
--- a/include/linux/nospec.h
+++ b/include/linux/nospec.h
@@ -11,10 +11,6 @@
 
 struct task_struct;
 
-#ifndef barrier_nospec
-# define barrier_nospec() do { } while (0)
-#endif
-
 /**
  * array_index_mask_nospec() - generate a ~0 mask when index < size, 0 otherwise
  * @index: array element index
diff --git a/kernel/bpf/core.c b/kernel/bpf/core.c
index 430c66d59..ba3fff17e 100644
--- a/kernel/bpf/core.c
+++ b/kernel/bpf/core.c
@@ -1910,7 +1910,9 @@ static u64 ___bpf_prog_run(u64 *regs, const struct bpf_insn *insn)
 		 * reuse preexisting logic from Spectre v1 mitigation that
 		 * happens to produce the required code on x86 for v4 as well.
 		 */
+#ifdef CONFIG_X86
 		barrier_nospec();
+#endif
 		CONT;
 #define LDST(SIZEOP, SIZE)						\
 	STX_MEM_##SIZEOP:						\
diff --git a/lib/usercopy.c b/lib/usercopy.c
index d29fe29c6..1505a52f2 100644
--- a/lib/usercopy.c
+++ b/lib/usercopy.c
@@ -3,7 +3,6 @@
 #include <linux/fault-inject-usercopy.h>
 #include <linux/instrumented.h>
 #include <linux/uaccess.h>
-#include <linux/nospec.h>
 
 /* out-of-line parts */
 
@@ -13,12 +12,6 @@ unsigned long _copy_from_user(void *to, const void __user *from, unsigned long n
 	unsigned long res = n;
 	might_fault();
 	if (!should_fail_usercopy() && likely(access_ok(from, n))) {
-		/*
-		 * Ensure that bad access_ok() speculation will not
-		 * lead to nasty side effects *after* the copy is
-		 * finished:
-		 */
-		barrier_nospec();
 		instrument_copy_from_user_before(to, from, n);
 		res = raw_copy_from_user(to, from, n);
 		instrument_copy_from_user_after(to, from, n, res);
-- 
2.39.2.501.gd9d677b2d8

